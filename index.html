<!DOCTYPE html>  
<html>  
<head>  
<meta charset="UTF-8">  
<title>Insert title here</title>
 
    <script type="text/javascript" src="src/qrcode/alignpat.js"></script>
    <script type="text/javascript" src="src/qrcode/version.js"></script>
    <script type="text/javascript" src="src/qrcode/detector.js"></script>
    <script type="text/javascript" src="src/qrcode/formatinf.js"></script>
    <script type="text/javascript" src="src/qrcode/errorlevel.js"></script>
    <script type="text/javascript" src="src/qrcode/bitmat.js"></script>
    <script type="text/javascript" src="src/qrcode/datablock.js"></script>
    <script type="text/javascript" src="src/qrcode/bmparser.js"></script>
    <script type="text/javascript" src="src/qrcode/datamask.js"></script>
    <script type="text/javascript" src="src/qrcode/rsdecoder.js"></script>
    <script type="text/javascript" src="src/qrcode/gf256poly.js"></script>
    <script type="text/javascript" src="src/qrcode/gf256.js"></script>
    <script type="text/javascript" src="src/qrcode/decoder.js"></script>
    <script type="text/javascript" src="src/qrcode/qrcode.js"></script>
    <script type="text/javascript" src="src/qrcode/findpat.js"></script>
    <script type="text/javascript" src="src/qrcode/alignpat.js"></script>
    <script type="text/javascript" src="src/qrcode/databr.js"></script>
 
</head>  
<body>  
<video id="video"  autoplay=""style='width:100%;height:100%;border:1px solid black'></video>
<canvas id="canvas" style='display:none' width="400" height="400"></canvas>
 
<div id='pic_box'></div>
<div id='text_box'></div>
 
<script type="text/javascript">
 
    function writeObj(obj){
        var description = "";
        for(var i in obj){
            var property=obj[i];
            description+=i+" = "+property+"\n";
        }
        alert(description);
    }
 
    //谷歌浏览器(电脑前置摄像头)扫描成功
    var count = 0;
    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    console.log("123453456");
    navigator.mediaDevices.getUserMedia({
        video: true
    })
    .then(function(stream){
      if ("srcObject" in video) {
          video.srcObject = stream;
         } else {
          // Avoid using this in new browsers, as it is going away.
         video.src = window.URL.createObjectURL(stream);
        }

        video.onloadedmetadata = function(e) {
            video.play();
        };
        //每秒用canvas绘制一副图后用二维码解析库解析
        video.addEventListener("timeupdate", checkCode);
    })
    .catch(function(e){
        alert(e);
        console.log(e);
    });
 
    function checkCode(){

      var opts = {
          errorCorrectionLevel: 'H',
          type: 'image/jpeg',
          quality: 0.3,
          margin: 1,
          color: {
            dark:"#010599FF",
            light:"#FFBF60FF"
          }
      }

        let text = canvas.getContext('2d').drawImage(video, 0, 0, 400, 400);
        console.log( canvas.getContext('2d').drawImage(video, 0, 0, 400, 400));
        qrcode.decode(canvas.toDataURL(text,opts));

        qrcode.callback = function(data){
          console.log("qrcode.callback");
            if(data == 'error decoding QR Code'){
                document.getElementById('text_box').innerText = '第' + count + '次:' + data;
                count ++;
            }else{
                video.removeEventListener('timeupdate', checkCode);
                alert(data);
                //location.href = data;
            }
        }
    }
 
</script>  
  
</body>  
</html>  
